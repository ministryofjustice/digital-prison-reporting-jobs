version: 2.1

orbs:
  reporting: ministryofjustice/hmpps-reporting@dev:e6c8666d1584dd7d95ef11165b45ae7809d16f6e
  slack: circleci/slack@4.12.5

workflows:
  checkout-build-publish:
    jobs:
      - reporting/gradle_owasp_check:
          notify_slack: false
          context:
            - hmpps-reporting-common
            - hmpps-reporting-orb
          cache_key: "owasp-build-cache-v7"
          pre-steps:
            # Use an isolated Gradle home so the orb's restored ~/.gradle cache is ignored
            - run:
                name: Isolate Gradle cache + pin H2 + sane defaults
                command: |
                  echo 'export GRADLE_USER_HOME=/tmp/gradle-home' >> "$BASH_ENV"
                  echo 'export GRADLE_OPTS="-Xmx2g -XX:MaxMetaspaceSize=512m -Dfile.encoding=UTF-8 -Dorg.gradle.workers.max=1"' >> "$BASH_ENV"
                  mkdir -p /tmp/gradle-home/init.d
                  cat > /tmp/gradle-home/init.d/pin-h2.gradle \<<'EOF'
                  allprojects {
                    configurations.configureEach {
                      resolutionStrategy.eachDependency { d ->
                        if (d.requested.group == 'com.h2database' && d.requested.name == 'h2') {
                          d.useVersion '2.2.224'
                          d.because 'Work around CI jar-cache write failure for h2-2.3.232'
                        }
                      }
                    }
                    buildscript {
                      configurations.configureEach {
                        resolutionStrategy.eachDependency { d ->
                          if (d.requested.group == 'com.h2database' && d.requested.name == 'h2') {
                            d.useVersion '2.2.224'
                          }
                        }
                      }
                    }
                  }
                  EOF
            - run:
                name: Gradle properties
                command: |
                  mkdir -p ~/.gradle
                  printf '%s\n' \
                    'org.gradle.jvmargs=-Xmx2048m -Dfile.encoding=UTF-8' \
                    'org.gradle.daemon=false' \
                    'org.gradle.workers.max=1' > ~/.gradle/gradle.properties
            - run:
                name: Disk space (debug)
                command: df -h

      - reporting/gradle_build_publish:
          tag: "8.0"
          app: digital-prison-reporting-jobs
          app_artifacts_directory: build/libs/
          bucket_prefix: dpr-artifact-store
          sync_args: "--exclude '*' --include '*-all*jar'"
          deploy_script: true
          deploy_to_test: true
          notify_jira: true
          notify_slack: true
          channel: dpr_cicd_alerts
          command: clean --refresh-dependencies jar shadowJar
          filters:
            branches:
              only: /.*/
            tags:
              ignore: /.*/
          ref: << pipeline.git.branch >><< pipeline.git.tag >>
          context:
            - hmpps-reporting-common
            - hmpps-reporting-orb
          cache_key: "dpr-jobs-build-cache-v7"
          pre-steps:
            - run:
                name: Isolate Gradle cache + pin H2 + sane defaults
                command: |
                  echo 'export GRADLE_USER_HOME=/tmp/gradle-home' >> "$BASH_ENV"
                  echo 'export GRADLE_OPTS="-Xmx2g -XX:MaxMetaspaceSize=512m -Dfile.encoding=UTF-8 -Dorg.gradle.workers.max=1"' >> "$BASH_ENV"
                  mkdir -p /tmp/gradle-home/init.d
                  cat > /tmp/gradle-home/init.d/pin-h2.gradle \<<'EOF'
                  allprojects {
                    configurations.configureEach {
                      resolutionStrategy.eachDependency { d ->
                        if (d.requested.group == 'com.h2database' && d.requested.name == 'h2') {
                          d.useVersion '2.2.224'
                          d.because 'Work around CI jar-cache write failure for h2-2.3.232'
                        }
                      }
                    }
                    buildscript {
                      configurations.configureEach {
                        resolutionStrategy.eachDependency { d ->
                          if (d.requested.group == 'com.h2database' && d.requested.name == 'h2') {
                            d.useVersion '2.2.224'
                          }
                        }
                      }
                    }
                  }
                  EOF
            - run:
                name: Gradle properties
                command: |
                  mkdir -p ~/.gradle
                  printf '%s\n' \
                    'org.gradle.jvmargs=-Xmx2048m -Dfile.encoding=UTF-8' \
                    'org.gradle.daemon=false' \
                    'org.gradle.workers.max=1' > ~/.gradle/gradle.properties
            - run:
                name: Disk space (debug)
                command: df -h

      - slack/on-hold:
          channel: dpr_cicd_approvals
          filters:
            branches:
              only: main
            tags:
              ignore: /.*/
          context:
            - hmpps-reporting-common
          requires: [reporting/gradle_build_publish]

      - pause_workflow:
          channel: dpr_cicd_approvals
          type: approval
          filters:
            branches:
              only: main
            tags:
              ignore: /.*/
          context:
            - hmpps-reporting-common
          requires: [slack/on-hold]

      - reporting/gradle_promote_live:
          app: digital-prison-reporting-jobs
          sync_args: "--exclude '*' --include '*-all*jar'"
          deploy_script: true
          release_ready: true
          notify_slack: true
          filters:
            branches:
              only: main
            tags:
              ignore: /.*/
          requires: [pause_workflow]
          context:
            - hmpps-reporting-common

  owasp-security:
    triggers:
      - schedule:
          cron: "30 6 * * *" # 7:30 AM UK
          filters:
            branches:
              only:
                - main
    jobs:
      - reporting/gradle_owasp_check:
          notify_slack: true
          channel: dpr_cicd_alerts
          context:
            - hmpps-reporting-common
            - hmpps-reporting-orb
          cache_key: "owasp-build-cache-v7"
          pre-steps:
            - run:
                name: Isolate Gradle cache + pin H2 + sane defaults
                command: |
                  echo 'export GRADLE_USER_HOME=/tmp/gradle-home' >> "$BASH_ENV"
                  echo 'export GRADLE_OPTS="-Xmx2g -XX:MaxMetaspaceSize=512m -Dfile.encoding=UTF-8 -Dorg.gradle.workers.max=1"' >> "$BASH_ENV"
                  mkdir -p /tmp/gradle-home/init.d
                  cat > /tmp/gradle-home/init.d/pin-h2.gradle \<<'EOF'
                  allprojects {
                    configurations.configureEach {
                      resolutionStrategy.eachDependency { d ->
                        if (d.requested.group == 'com.h2database' && d.requested.name == 'h2') {
                          d.useVersion '2.2.224'
                          d.because 'Work around CI jar-cache write failure for h2-2.3.232'
                        }
                      }
                    }
                    buildscript {
                      configurations.configureEach {
                        resolutionStrategy.eachDependency { d ->
                          if (d.requested.group == 'com.h2database' && d.requested.name == 'h2') {
                            d.useVersion '2.2.224'
                          }
                        }
                      }
                    }
                  }
                  EOF
            - run:
                name: Gradle properties
                command: |
                  mkdir -p ~/.gradle
                  printf '%s\n' \
                    'org.gradle.jvmargs=-Xmx2048m -Dfile.encoding=UTF-8' \
                    'org.gradle.daemon=false' \
                    'org.gradle.workers.max=1' > ~/.gradle/gradle.properties
