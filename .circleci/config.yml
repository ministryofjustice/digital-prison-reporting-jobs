version: 2.1

orbs:
  reporting: ministryofjustice/hmpps-reporting@dev:e6c8666d1584dd7d95ef11165b45ae7809d16f6e
  slack: circleci/slack@4.12.5

workflows:
  checkout-build-publish:
    jobs:
      - reporting/gradle_owasp_check:
          notify_slack: false
          context:
            - hmpps-reporting-common
            - hmpps-reporting-orb
          cache_key: "owasp-build-cache-v10"
          pre-steps:
            - run:
                name: Isolate Gradle in WORKSPACE (not /tmp) + pin H2 + sane defaults
                command: |
                  # Put Gradle + temp inside the project workspace to avoid /tmp inode exhaustion
                  export GRADLE_USER_HOME="$PWD/.gradle-ci/${CIRCLE_WORKFLOW_ID}-${CIRCLE_JOB}"
                  mkdir -p "$GRADLE_USER_HOME/init.d" "$GRADLE_USER_HOME/tmp"

                  # Persist env + limits across steps
                  {
                    echo "export GRADLE_USER_HOME=$GRADLE_USER_HOME"
                    echo 'export _JAVA_OPTIONS="-Djava.io.tmpdir=$GRADLE_USER_HOME/tmp"'
                    echo 'export TMPDIR="$GRADLE_USER_HOME/tmp"'
                    echo 'export GRADLE_OPTS="-Xmx2g -XX:MaxMetaspaceSize=512m -Dfile.encoding=UTF-8 -Dorg.gradle.workers.max=1 -Dorg.gradle.vfs.watch=false -Dorg.gradle.io.native=false"'
                    # Raise open files limit (helps when resolving many artifacts)
                    echo 'ulimit -n 8192 || true'
                  } >> "$BASH_ENV"

                  # Gradle properties (disable build cache in CI)
                  cat > "$GRADLE_USER_HOME/gradle.properties" <<'PROPS'
                  org.gradle.jvmargs=-Xmx2048m -XX:MaxMetaspaceSize=512m -Dfile.encoding=UTF-8
                  org.gradle.daemon=false
                  org.gradle.parallel=false
                  org.gradle.workers.max=1
                  org.gradle.vfs.watch=false
                  systemProp.org.gradle.internal.http.connectionTimeout=120000
                  systemProp.org.gradle.internal.http.socketTimeout=120000
                  org.gradle.caching=false
                  PROPS

                  # Pin H2 (avoids a known CI jar-cache write quirk)
                  cat > "$GRADLE_USER_HOME/init.d/pin-h2.gradle" <<'EOF'
                  allprojects {
                    configurations.configureEach {
                      resolutionStrategy.eachDependency { d ->
                        if (d.requested.group == 'com.h2database' && d.requested.name == 'h2') {
                          d.useVersion '2.1.214'
                          d.because 'Avoid CI jar-cache write failure'
                        }
                      }
                    }
                    buildscript {
                      configurations.configureEach {
                        resolutionStrategy.eachDependency { d ->
                          if (d.requested.group == 'com.h2database' && d.requested.name == 'h2') {
                            d.useVersion '2.1.214'
                          }
                        }
                      }
                    }
                  }
                  EOF

                  # Start each job with a clean cache in the new location
                  rm -rf "$GRADLE_USER_HOME/caches" "$GRADLE_USER_HOME/.tmp/gradle_download"* || true
                  df -h
                  df -i || true
                  ulimit -a || true
            - run:
                name: Show GRADLE_USER_HOME
                command: |
                  echo "GRADLE_USER_HOME=$GRADLE_USER_HOME"
          post-steps:
            - store_artifacts:
                path: build/reports/dependency-check-report.html
                destination: owasp
            - store_artifacts:
                path: build/reports/dependency-check-report.json
                destination: owasp

      - reporting/gradle_build_publish:
          tag: "8.0"
          app: digital-prison-reporting-jobs
          app_artifacts_directory: build/libs/
          bucket_prefix: dpr-artifact-store
          sync_args: "--exclude '*' --include '*-all*jar'"
          deploy_script: true
          deploy_to_test: true
          notify_jira: true
          notify_slack: true
          channel: dpr_cicd_alerts
          command: clean --refresh-dependencies check shadowJar
          filters:
            branches:
              only: /.*/
            tags:
              ignore: /.*/
          ref: << pipeline.git.branch >><< pipeline.git.tag >>
          context:
            - hmpps-reporting-common
            - hmpps-reporting-orb
          cache_key: "dpr-jobs-build-cache-v10"
          pre-steps:
            - run:
                name: Isolate Gradle in WORKSPACE (not /tmp) + pin H2 + sane defaults
                command: |
                  export GRADLE_USER_HOME="$PWD/.gradle-ci/${CIRCLE_WORKFLOW_ID}-${CIRCLE_JOB}"
                  mkdir -p "$GRADLE_USER_HOME/init.d" "$GRADLE_USER_HOME/tmp"
                  {
                    echo "export GRADLE_USER_HOME=$GRADLE_USER_HOME"
                    echo 'export _JAVA_OPTIONS="-Djava.io.tmpdir=$GRADLE_USER_HOME/tmp"'
                    echo 'export TMPDIR="$GRADLE_USER_HOME/tmp"'
                    echo 'export GRADLE_OPTS="-Xmx2g -XX:MaxMetaspaceSize=512m -Dfile.encoding=UTF-8 -Dorg.gradle.workers.max=1 -Dorg.gradle.vfs.watch=false -Dorg.gradle.io.native=false"'
                    echo 'ulimit -n 8192 || true'
                  } >> "$BASH_ENV"

                  cat > "$GRADLE_USER_HOME/gradle.properties" <<'PROPS'
                  org.gradle.jvmargs=-Xmx2048m -XX:MaxMetaspaceSize=512m -Dfile.encoding=UTF-8
                  org.gradle.daemon=false
                  org.gradle.parallel=false
                  org.gradle.workers.max=1
                  org.gradle.vfs.watch=false
                  systemProp.org.gradle.internal.http.connectionTimeout=120000
                  systemProp.org.gradle.internal.http.socketTimeout=120000
                  org.gradle.caching=false
                  PROPS

                  cat > "$GRADLE_USER_HOME/init.d/pin-h2.gradle" <<'EOF'
                  allprojects {
                    configurations.configureEach {
                      resolutionStrategy.eachDependency { d ->
                        if (d.requested.group == 'com.h2database' && d.requested.name == 'h2') {
                          d.useVersion '2.1.214'
                          d.because 'Avoid CI jar-cache write failure'
                        }
                      }
                    }
                    buildscript {
                      configurations.configureEach {
                        resolutionStrategy.eachDependency { d ->
                          if (d.requested.group == 'com.h2database' && d.requested.name == 'h2') {
                            d.useVersion '2.1.214'
                          }
                        }
                      }
                    }
                  }
                  EOF

                  rm -rf "$GRADLE_USER_HOME/caches" "$GRADLE_USER_HOME/.tmp/gradle_download"* || true
                  df -h
                  df -i || true
                  ulimit -a || true
            - run:
                name: Show GRADLE_USER_HOME
                command: |
                  echo "GRADLE_USER_HOME=$GRADLE_USER_HOME"
          post-steps:
            - store_artifacts:
                path: build/libs
                destination: libs
            - store_artifacts:
                path: build/reports/tests/test
                destination: tests-html
            - store_artifacts:
                path: build/reports/jacoco/test/html
                destination: jacoco
            - store_test_results:
                path: build/test-results/test

      - slack/on-hold:
          channel: dpr_cicd_approvals
          filters:
            branches:
              only: main
            tags:
              ignore: /.*/
          context:
            - hmpps-reporting-common
          requires: [reporting/gradle_build_publish]

      - pause_workflow:
          channel: dpr_cicd_approvals
          type: approval
          filters:
            branches:
              only: main
            tags:
              ignore: /.*/
          context:
            - hmpps-reporting-common
          requires: [slack/on-hold]

      - reporting/gradle_promote_live:
          app: digital-prison-reporting-jobs
          sync_args: "--exclude '*' --include '*-all*jar'"
          deploy_script: true
          release_ready: true
          notify_slack: true
          filters:
            branches:
              only: main
            tags:
              ignore: /.*/
          requires: [pause_workflow]
          context:
            - hmpps-reporting-common

  owasp-security:
    triggers:
      - schedule:
          cron: "30 6 * * *" # 7:30 AM UK
          filters:
            branches:
              only:
                - main
    jobs:
      - reporting/gradle_owasp_check:
          notify_slack: true
          channel: dpr_cicd_alerts
          context:
            - hmpps-reporting-common
            - hmpps-reporting-orb
          cache_key: "owasp-build-cache-v10"
          pre-steps:
            - run:
                name: Isolate Gradle in WORKSPACE (not /tmp) + pin H2 + sane defaults
                command: |
                  export GRADLE_USER_HOME="$PWD/.gradle-ci/${CIRCLE_WORKFLOW_ID}-${CIRCLE_JOB}"
                  mkdir -p "$GRADLE_USER_HOME/init.d" "$GRADLE_USER_HOME/tmp"
                  {
                    echo "export GRADLE_USER_HOME=$GRADLE_USER_HOME"
                    echo 'export _JAVA_OPTIONS="-Djava.io.tmpdir=$GRADLE_USER_HOME/tmp"'
                    echo 'export TMPDIR="$GRADLE_USER_HOME/tmp"'
                    echo 'export GRADLE_OPTS="-Xmx2g -XX:MaxMetaspaceSize=512m -Dfile.encoding=UTF-8 -Dorg.gradle.workers.max=1 -Dorg.gradle.vfs.watch=false -Dorg.gradle.io.native=false"'
                    echo 'ulimit -n 8192 || true'
                  } >> "$BASH_ENV"

                  cat > "$GRADLE_USER_HOME/gradle.properties" <<'PROPS'
                  org.gradle.jvmargs=-Xmx2048m -XX:MaxMetaspaceSize=512m -Dfile.encoding=UTF-8
                  org.gradle.daemon=false
                  org.gradle.parallel=false
                  org.gradle.workers.max=1
                  org.gradle.vfs.watch=false
                  systemProp.org.gradle.internal.http.connectionTimeout=120000
                  systemProp.org.gradle.internal.http.socketTimeout=120000
                  org.gradle.caching=false
                  PROPS

                  cat > "$GRADLE_USER_HOME/init.d/pin-h2.gradle" <<'EOF'
                  allprojects {
                    configurations.configureEach {
                      resolutionStrategy.eachDependency { d ->
                        if (d.requested.group == 'com.h2database' && d.requested.name == 'h2') {
                          d.useVersion '2.1.214'
                          d.because 'Avoid CI jar-cache write failure'
                        }
                      }
                    }
                    buildscript {
                      configurations.configureEach {
                        resolutionStrategy.eachDependency { d ->
                          if (d.requested.group == 'com.h2database' && d.requested.name == 'h2') {
                            d.useVersion '2.1.214'
                          }
                        }
                      }
                    }
                  }
                  EOF

                  rm -rf "$GRADLE_USER_HOME/caches" "$GRADLE_USER_HOME/.tmp/gradle_download"* || true
                  df -h
                  df -i || true
                  ulimit -a || true
            - run:
                name: Show GRADLE_USER_HOME
                command: |
                  echo "GRADLE_USER_HOME=$GRADLE_USER_HOME"
          post-steps:
            - store_artifacts:
                path: build/reports/dependency-check-report.html
                destination: owasp
            - store_artifacts:
                path: build/reports/dependency-check-report.json
                destination: owasp
